<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inbox - AI Email Assistant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .navbar {
      background: #ffffff;
      border-bottom: 1px solid #e5e5e5;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar h1 {
      font-size: 1.25rem;
      color: #1a1a1a;
      font-weight: 600;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .nav-links a {
      color: #666;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: #1a1a1a;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2rem;
      color: #1a1a1a;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .stat-card p {
      color: #666;
      font-size: 0.9rem;
    }

    .controls {
      background: white;
      padding: 1rem;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1a1a1a;
      color: white;
      border: 1px solid #1a1a1a;
    }

    .btn-primary:hover {
      background: #333;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: white;
      color: #1a1a1a;
      border: 1px solid #e5e5e5;
    }

    .btn-secondary:hover {
      background: #fafafa;
    }

    select {
      padding: 0.6rem 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .email-list {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      overflow: hidden;
    }

    .email-item {
      padding: 1.5rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 1rem;
      align-items: start;
      transition: background 0.2s;
      cursor: pointer;
    }

    .email-item:hover {
      background: #fafafa;
    }

    .email-item:last-child {
      border-bottom: none;
    }

    .email-checkbox {
      margin-top: 0.3rem;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .email-content {
      flex: 1;
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }

    .email-from {
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }

    .email-date {
      font-size: 0.85rem;
      color: #999;
    }

    .email-subject {
      font-weight: 500;
      color: #555;
      margin-bottom: 0.5rem;
    }

    .email-snippet {
      color: #777;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .badge-high {
      background: #ffe0e0;
      color: #d32f2f;
    }

    .badge-medium {
      background: #fff3e0;
      color: #f57c00;
    }

    .badge-low {
      background: #e8f5e9;
      color: #388e3c;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: white;
      font-size: 1.2rem;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #999;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    #detail-panel {
      margin-top: 2rem;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: none;
    }

    #detail-panel.show {
      display: block;
    }

    .flash-message {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid #667eea;
    }

    .flash-message.danger {
      border-left-color: #d32f2f;
    }

    .flash-message.success {
      border-left-color: #388e3c;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <h1><a href="{{ url_for('index') }}" style="text-decoration: none; color: inherit;">ODIN</a></h1>
    <div class="nav-links">
      <a href="{{ url_for('inbox') }}">Inbox</a>
      <a href="{{ url_for('analytics') }}">Analytics</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </div>
  </nav>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash-message {{ category }}">
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="total-count">{{ messages|length }}</h3>
        <p>Total Emails</p>
      </div>
      <div class="stat-card">
        <h3 id="selected-count">0</h3>
        <p>Selected</p>
      </div>
    </div>

    {% if messages %}
    <div class="controls">
      <button class="btn btn-primary" onclick="analyzeSelected()">Analyze Selected</button>
      <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
      <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
      <select id="filterCategory" onchange="filterByCategory()">
        <option value="">All Categories</option>
        <option value="Urgent Support">Urgent Support</option>
        <option value="Work/Business">Work/Business</option>
        <option value="Personal">Personal</option>
        <option value="Newsletter">Newsletter</option>
        <option value="Spam/Promotional">Spam/Promotional</option>
      </select>
      <select id="sortOrder" onchange="sortEmails()">
        <option value="date_desc">Newest First</option>
        <option value="date_asc">Oldest First</option>
      </select>
    </div>

    <div class="email-list">
      {% for mail in messages %}
      <div class="email-item" data-id="{{ mail.id }}" data-date="{{ mail.date }}"
        onclick="openEmail('{{ mail.id }}', event)">
        <input type="checkbox" class="email-checkbox" data-id="{{ mail.id }}"
          onclick="event.stopPropagation(); updateSelectedCount();">
        <div class="email-content">
          <div class="email-header">
            <span class="email-from">{{ mail.from }}</span>
            <span class="email-date">{{ mail.date }}</span>
          </div>
          <div class="email-subject">{{ mail.subject }}</div>
          <div class="email-snippet">{{ mail.snippet }}</div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div id="detail-panel"></div>
    {% else %}
    <div class="email-list">
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
          </path>
        </svg>
        <h3>No emails found</h3>
        <p>Your inbox is empty or no messages match the current filter.</p>
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    function updateSelectedCount() {
      const count = document.querySelectorAll('.email-checkbox:checked').length;
      document.getElementById('selected-count').textContent = count;
    }

    function selectAll() {
      document.querySelectorAll('.email-checkbox').forEach(cb => cb.checked = true);
      updateSelectedCount();
    }

    function clearSelection() {
      document.querySelectorAll('.email-checkbox').forEach(cb => cb.checked = false);
      updateSelectedCount();
      document.getElementById('detail-panel').classList.remove('show');
    }

    async function analyzeSelected() {
      const selected = Array.from(document.querySelectorAll('.email-checkbox:checked')).map(cb => cb.dataset.id);
      if (!selected.length) {
        alert('Please select at least one email');
        return;
      }

      const panel = document.getElementById('detail-panel');
      panel.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Analyzing emails...</div>';
      panel.classList.add('show');

      try {
        const results = await Promise.all(selected.map(id =>
          fetch(`/api/message/${id}`).then(r => r.json())
        ));

        let html = '<h2 style="margin-bottom: 1.5rem; color: #1a1a1a; font-weight: 600;">Analysis Results</h2>';
        results.forEach(data => {
          const priorityLower = data.priority ? data.priority.toLowerCase() : 'medium';
          const sentimentColor = data.sentiment === 'positive' ? '#388e3c' : data.sentiment === 'negative' ? '#d32f2f' : '#666';
          const sentimentScore = data.sentiment_score ? (data.sentiment_score * 100).toFixed(0) : '50';

          html += '<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">';
          html += '<h3 style="color: #1a1a1a; margin-bottom: 1rem; font-weight: 600;">' + (data.subject || 'No Subject') + '</h3>';
          html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">';
          html += '<div><strong>Priority:</strong> <span class="badge badge-' + priorityLower + '">' + data.priority + '</span></div>';
          html += '<div><strong>Sentiment:</strong> <span style="color: ' + sentimentColor + ';">' + data.sentiment + ' (' + sentimentScore + '%)</span></div>';
          html += '<div><strong>Category:</strong> ' + data.category + '</div>';
          html += '</div>';
          html += '<div style="background: #fafafa; padding: 1rem; border-radius: 6px; border: 1px solid #e5e5e5; margin-bottom: 1rem;">';
          html += '<strong>Summary:</strong><br><div style="margin-top: 0.5rem; white-space: pre-wrap;">' + data.summary + '</div>';
          html += '</div>';

          if (data.extracted_info && (data.extracted_info.action_items || data.extracted_info.dates)) {
            html += '<div style="margin-top: 1rem;">';
            if (data.extracted_info.action_items && data.extracted_info.action_items.length > 0) {
              html += '<strong>Action Items:</strong><ul style="margin: 0.5rem 0 0 1.5rem;">';
              data.extracted_info.action_items.forEach(item => {
                html += '<li>' + item + '</li>';
              });
              html += '</ul>';
            }
            if (data.extracted_info.dates && data.extracted_info.dates.length > 0) {
              html += '<strong>Important Dates:</strong> ' + data.extracted_info.dates.join(', ');
            }
            html += '</div>';
          }

          html += '<a href="/message/' + data.id + '" style="display: inline-block; margin-top: 1rem; color: #1a1a1a; text-decoration: none; font-weight: 600; border-bottom: 1px solid #1a1a1a;">View Full Details</a>';
          html += '</div>';
        });

        panel.innerHTML = html;
      } catch (error) {
        panel.innerHTML = `<div style="color: #d32f2f;">Error: ${error.message}</div>`;
      }
    }

    function openEmail(id, event) {
      if (event.target.type === 'checkbox') return;
      window.location.href = `/message/${id}`;
    }

    function sortEmails() {
      const order = document.getElementById('sortOrder').value;
      const container = document.querySelector('.email-list');
      const items = Array.from(document.querySelectorAll('.email-item'));

      items.sort((a, b) => {
        const dateA = a.dataset.date || '';
        const dateB = b.dataset.date || '';
        return order === 'date_desc' ? dateB.localeCompare(dateA) : dateA.localeCompare(dateB);
      });

      items.forEach(item => container.appendChild(item));
    }

    function filterByCategory() {
      const category = document.getElementById('filterCategory').value;
      // This would require category data on each email item
      // For now, just a placeholder
      alert('Category filtering will work after analyzing emails');
    }
  </script>
</body>

</html>